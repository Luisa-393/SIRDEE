<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detección de Dígitos en Video</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">Detección de Dígitos en Video</h1>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="mb-3">
          <label for="videoFile" class="form-label">Seleccionar video:</label>
          <input class="form-control" type="file" id="videoFile" accept="video/mp4,video/*">
        </div>

        <div class="mb-3">
          <label for="modelFile" class="form-label">Seleccionar modelo YOLO (.pt):</label>
          <input class="form-control" type="file" id="modelFile" accept=".pt">
        </div>

        <div class="mb-3">
          <label for="intervalInput" class="form-label">Intervalo de captura (ms):</label>
          <input class="form-control" type="number" id="intervalInput" value="500" min="100">
        </div>

        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary" onclick="uploadVideo()">Subir Video</button>
          <button type="button" class="btn btn-success" onclick="processVideo(event)">Procesar Video</button>

        </div>

        <div class="mt-4 text-center" id="statusLabel">
          <span class="text-muted">Esperando archivo...</span>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Resultados por frame:</h5>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="resultTable">
            <thead class="table-light">
              <tr>
                <th>Frame</th>
                <th>Resultado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    console.log("Página cargada - location.href =", window.location.href);

    function uploadVideo() {
      const video = document.getElementById('videoFile').files[0];
      const model = document.getElementById('modelFile').files[0];
      if (!video || !model) {
        document.getElementById('statusLabel').innerHTML = '<span class="text-danger">Debe seleccionar un video y un modelo.</span>';
        return;
      }
      document.getElementById('statusLabel').innerHTML = '<span class="text-info">Video y modelo cargados correctamente.</span>';
    }

    function processVideo(event) {
      console.log("Botón clicado - evitando recarga...");


      if (event) event.preventDefault(); // <- PREVIENE el comportamiento por defecto del formulario
      console.log("processVideo ejecutado");

      const videoFile = document.getElementById('videoFile').files[0];
      const modelFile = document.getElementById('modelFile').files[0];
      const intervalo = document.getElementById('intervalInput').value;

      console.log("Archivos seleccionados:", videoFile, modelFile);

      if (!videoFile || !modelFile) {
        document.getElementById('statusLabel').innerHTML = '<span class="text-danger">Selecciona un video y modelo.</span>';
        return;
      }

      const formData = new FormData();
      formData.append("video", videoFile);
      formData.append("modelo", modelFile);
      formData.append("intervalo_ms", intervalo);

      document.getElementById('statusLabel').innerHTML = '<span class="text-warning">Procesando...</span>';



      console.log("Enviando fetch...");


      fetch("http://localhost:8000/procesar", {
        method: "POST",
        body: formData
      })
        .then(res => res.text())  // <-- CAMBIO AQUÍ: en vez de .json()
        .then(text => {
          console.log("Respuesta en texto plano:", text);  // <-- para ver qué devuelve realmente el backend
          try {
            const data = JSON.parse(text);  // intenta convertirlo a JSON
            const resultados = data.resultados;
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = ''; // limpiar tabla previa

            resultados.forEach(r => {
              const tr = document.createElement('tr');

              const tdFrame = document.createElement('td');
              tdFrame.textContent = r.frame;

              const tdResultado = document.createElement('td');
              tdResultado.textContent = r.resultado;

              tr.appendChild(tdFrame);
              tr.appendChild(tdResultado);
              tbody.appendChild(tr);
            });

            document.getElementById('statusLabel').innerHTML = '<span class="text-success">Procesamiento finalizado.</span>';
          } catch (err) {
            console.error("Error al parsear JSON:", err);
            console.warn("Texto recibido:", text);
            document.getElementById('statusLabel').innerHTML = '<span class="text-danger">Respuesta inválida del servidor.</span>';
          }
        })
        .catch(err => {
          console.error("Error durante fetch:", err);
          document.getElementById('statusLabel').innerHTML = '<span class="text-danger">Error durante el procesamiento.</span>';
        });
    }

  </script>
</body>

</html>